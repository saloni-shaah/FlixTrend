
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Users: Can read anyone's public profile, but can only write to their own.
    match /users/{userId} {
      allow read: if true;
      allow write: if isUser(userId);

      // Subcollections for users
      allow read, write: if isUser(userId);
    }
    
    // Notifications: Users can only access their own notifications.
    match /notifications/{userId}/{document=**} {
      allow read, write: if isUser(userId);
    }

    // Posts, Flashes, Songs, Playlists, Collections:
    // Logged-in users can read all. Users can only create their own.
    // Users can only update/delete their own posts.
    match /{path=**}/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // Comments, Stars, Relays, Poll Votes (subcollections of posts)
    // Logged-in users can read/write to any post's subcollections.
    // Deletes are restricted to the owner of the subcollection item.
    match /posts/{postId}/{subcollection}/{docId} {
      allow read, create: if isSignedIn();
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Chats (Groups & DMs)
    match /groups/{groupId} {
      // User can read a group's info if they are a member.
      allow read: if isSignedIn() && resource.data.members[request.auth.uid] != null;
      // Allow any signed-in user to create a group.
      allow create: if isSignedIn();
      // Only admins can update group info.
      allow update: if isSignedIn() && request.auth.uid in resource.data.admins;
      // Only the original creator can delete the group.
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }
    
    match /chats/{chatId}/messages/{messageId} {
        // For group chats, check membership. For DMs, check involvement.
        allow read, create: if isSignedIn() && (
            (exists(/databases/$(database)/documents/groups/$(chatId)) && get(/databases/$(database)/documents/groups/$(chatId)).data.members[request.auth.uid] != null) ||
            (request.auth.uid in chatId.split('_'))
        );
        // Users can only delete their own messages.
        allow delete: if isSignedIn() && resource.data.sender == request.auth.uid;
        allow update: if isSignedIn() && resource.data.sender == request.auth.uid;
    }
  }
}
