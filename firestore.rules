/**
 * @fileoverview Firestore Security Rules for Flixtrend Prototype
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles
 * and an advertiser-ownership model for ad campaigns and creatives.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 * - /adCampaigns/{campaignId}: Stores ad campaigns, accessible only to the campaign's owner (advertiserId).
 * - /adCampaigns/{campaignId}/creatives/{creativeId}: Stores ad creatives, accessible only to the campaign's owner.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Ad campaigns and creatives can only be created, updated, and deleted by the advertiser who owns the campaign.
 * - No public listing of users, campaigns, or creatives is allowed.
 *
 * Denormalization for Authorization:
 * - AdCampaigns: Documents must contain an `advertiserId` field matching the owner's UID.
 * - AdCreatives: Documents must contain a `campaignId` field linking them to their parent campaign, and authorization is derived from the parent campaign's `advertiserId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profile data, ensuring only the user can read and write their own profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates a profile with "uid": "user123".
     * @allow (get, update, delete) User with UID 'user123' reads/updates/deletes their own profile at /users/user123.
     * @deny (create) User with UID 'user123' tries to create a profile with "uid": "user456".
     * @deny (get, update, delete) User with UID 'user456' tries to access profile at /users/user123.
     * @principle Enforces document ownership for user profiles; only the owner can read/write.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.uid == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects ad campaigns, ensuring only the campaign owner can manage them.
     * @path /adCampaigns/{campaignId}
     * @allow (create) User with UID 'business123' creates a campaign with "advertiserId": "business123".
     * @allow (get, update, delete) User with UID 'business123' manages their campaign at /adCampaigns/campaignXYZ.
     * @deny (create) User with UID 'user456' tries to create a campaign with "advertiserId": "business123".
     * @deny (get, update, delete) User with UID 'user456' tries to access campaign at /adCampaigns/campaignXYZ.
     * @principle Enforces document ownership for ad campaigns; only the advertiser can manage.
     */
    match /adCampaigns/{campaignId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(advertiserId) {
        return isSignedIn() && request.auth.uid == advertiserId;
      }

      function isExistingOwner(advertiserId) {
        return isOwner(advertiserId) && resource != null;
      }

      allow get: if isOwner(resource.data.advertiserId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.advertiserId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.advertiserId) && resource.data.advertiserId == request.resource.data.advertiserId;
      allow delete: if isExistingOwner(resource.data.advertiserId);
    }

    /**
     * @description Protects ad creatives within a campaign, ensuring only the campaign owner can manage them.
     * @path /adCampaigns/{campaignId}/creatives/{creativeId}
     * @allow (create) User 'business123' creates a creative in their campaign at /adCampaigns/campaignXYZ/creatives/creative123.
     * @allow (get, update, delete) User 'business123' manages their creative at /adCampaigns/campaignXYZ/creatives/creative123.
     * @deny (create) User 'user456' tries to create a creative in campaign 'campaignXYZ' owned by 'business123'.
     * @deny (get, update, delete) User 'user456' tries to access creative at /adCampaigns/campaignXYZ/creatives/creative123.
     * @principle Enforces document ownership for ad creatives, linked to the parent campaign's ownership.
     */
    match /adCampaigns/{campaignId}/creatives/{creativeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function getCampaign(campaignId) {
          return get(/databases/$(database)/documents/adCampaigns/$(campaignId));
      }

      function isCampaignOwner(campaignId) {
        return isSignedIn() && getCampaign(campaignId).data.advertiserId == request.auth.uid;
      }

      function isExistingCampaignOwner(campaignId) {
        return isCampaignOwner(campaignId) && resource != null;
      }

      allow get: if isCampaignOwner(campaignId);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.campaignId == campaignId && isCampaignOwner(campaignId);
      allow update: if isExistingCampaignOwner(campaignId) && request.resource.data.campaignId == campaignId;
      allow delete: if isExistingCampaignOwner(campaignId) && request.resource.data.campaignId == campaignId;
    }
  }
}