/**
 * @description This ruleset enforces a user-ownership model for user profiles and links ad campaigns and creatives to their owners.
 * @dataStructure
 *   - `/users/{userId}`: Stores user profile data, accessible only to the user themselves.
 *   - `/adCampaigns/{campaignId}`: Stores ad campaign data, owned by a specific user (advertiserId).
 *   - `/adCampaigns/{campaignId}/creatives/{creativeId}`: Stores ad creatives, linked to a specific ad campaign.
 * @keySecurityDecisions
 *   - Users can only read and write their own profile data.
 *   - Ad campaigns can only be created by signed-in users.
 *   - Ad campaigns can only be managed (updated/deleted) by their owner (advertiserId).
 *   - Ad creatives can only be created and managed within their parent ad campaign, by the campaign owner.
 * @denormalizationForAuthorization
 *   - AdCampaign documents have an `advertiserId` field to directly link them to their owner.
 * @structuralSegregation N/A
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user owns the existing document (based on a denormalized ownerId field)
     */
    function isExistingOwner() {
      return isSignedIn() && resource.data.advertiserId == request.auth.uid;
    }

    /**
     * @description
     *   - Allows users to read their own profile.
     *   - Allows users to create their own profile.
     *   - Allows users to update their own profile.
     *   - Does not allow listing all user profiles.
     * @path /users/{userId}
     * @allow (get) User with UID 'user123' can read their profile at /users/user123.
     * @allow (create) User with UID 'user123' can create their profile at /users/user123.
     * @allow (update) User with UID 'user123' can update their profile at /users/user123.
     * @deny (get) User with UID 'user456' cannot read the profile of user 'user123' at /users/user123.
     * @deny (create) User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (update) User with UID 'user456' cannot update the profile of user 'user123' at /users/user123.
     * @principle Enforces document ownership for both reads and writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    /**
     * @description
     *   - Allows any signed-in user to create an ad campaign.
     *   - Enforces ownership for updating and deleting ad campaigns.
     *   - Does not allow public listing of all ad campaigns.
     * @path /adCampaigns/{campaignId}
     * @allow (create) User with UID 'user123' can create an ad campaign at /adCampaigns/campaign1, setting advertiserId to 'user123'.
     * @allow (update) User with UID 'user123' can update their ad campaign at /adCampaigns/campaign1, if advertiserId is 'user123'.
     * @allow (delete) User with UID 'user123' can delete their ad campaign at /adCampaigns/campaign1, if advertiserId is 'user123'.
     * @deny (get) User with UID 'user456' cannot read ad campaign 'campaign1' at /adCampaigns/campaign1.
     * @deny (create) User with UID 'user456' cannot create an ad campaign at /adCampaigns/campaign1 with advertiserId 'user123'.
     * @deny (update) User with UID 'user456' cannot update ad campaign 'campaign1' at /adCampaigns/campaign1 if advertiserId is 'user123'.
     * @principle Enforces document ownership for writes; requires user to be signed in to create.
     */
    match /adCampaigns/{campaignId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.advertiserId == request.auth.uid;
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description
     *   - Allows the owner of an ad campaign to create, update, and delete ad creatives within that campaign.
     *   - Enforces ownership based on the parent ad campaign's `advertiserId` field.
     *   - Restricts access to ad creatives to the campaign owner.
     * @path /adCampaigns/{campaignId}/creatives/{creativeId}
     * @allow (create) User with UID 'user123' can create a creative at /adCampaigns/campaign1/creatives/creative1 if they own campaign 'campaign1'.
     * @allow (update) User with UID 'user123' can update a creative at /adCampaigns/campaign1/creatives/creative1 if they own campaign 'campaign1'.
     * @allow (delete) User with UID 'user123' can delete a creative at /adCampaigns/campaign1/creatives/creative1 if they own campaign 'campaign1'.
     * @deny (get) User with UID 'user456' cannot read ad creative 'creative1' at /adCampaigns/campaign1/creatives/creative1.
     * @deny (create) User with UID 'user456' cannot create an ad creative at /adCampaigns/campaign1/creatives/creative1 if they do not own campaign 'campaign1'.
     * @deny (update) User with UID 'user456' cannot update ad creative 'creative1' at /adCampaigns/campaign1/creatives/creative1 if they do not own campaign 'campaign1'.
     * @principle Enforces ownership based on the parent document's ownership.
     */
    match /adCampaigns/{campaignId}/creatives/{creativeId} {
      allow get: if isSignedIn() && get(/databases/$(database)/documents/adCampaigns/$(campaignId)).data.advertiserId == request.auth.uid;
      allow list: if false;
      allow create: if isSignedIn() && get(/databases/$(database)/documents/adCampaigns/$(campaignId)).data.advertiserId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/adCampaigns/$(campaignId)).data.advertiserId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/adCampaigns/$(campaignId)).data.advertiserId == request.auth.uid;
    }
  }
}