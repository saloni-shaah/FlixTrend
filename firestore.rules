rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // Helper Functions
    // ---------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isUserAdmin(userId) {
      let roles = getUserData(userId).role;
      return isSignedIn() && ('founder' in roles || 'developer' in roles);
    }
    
    function isGroupMember(groupId) {
      return isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.members.hasAny([request.auth.uid]);
    }
    
     function isGroupAdmin(groupId) {
      return isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.admins.hasAny([request.auth.uid]);
    }


    // ---------------------------
    // User Profiles
    // ---------------------------
    match /users/{userId} {
      // Anyone can view a user's public profile.
      allow read: if true;
      // A user can create their own profile document.
      allow create: if isUser(userId);
      // A user can only update their own profile. Admins can also update profiles.
      allow update: if isUser(userId) || isUserAdmin(request.auth.uid);
      // A user can delete their own profile document (handled by a cloud function).
      allow delete: if isUser(userId) || isUserAdmin(request.auth.uid);
      
      // Subcollections
      match /following/{followingId} {
      	allow read, write, delete: if isUser(userId);
      }
       match /followers/{followerId} {
      	allow read: if true;
        allow write, delete: if isSignedIn(); // Follow can be initiated by anyone
      }
       match /starredPosts/{postId} {
      	allow read, write, delete: if isUser(userId);
      }
       match /notifications/{notificationId} {
        allow read, write, delete: if isUser(userId);
      }
    }

    // ---------------------------
    // Posts, Flashes, and Subcollections
    // ---------------------------
    match /posts/{postId} {
      // Any signed-in user can read posts.
      allow read: if isSignedIn();
      // Any signed-in user can create a post.
      allow create: if isSignedIn();
      // Users can only update/delete their own posts. Admins can also delete.
      allow update: if isUser(resource.data.userId);
      allow delete: if isUser(resource.data.userId) || isUserAdmin(request.auth.uid);

      match /comments/{commentId} {
        allow read, write: if isSignedIn();
      }
      match /stars/{starId} {
        allow read, write: if isSignedIn();
      }
       match /relays/{relayId} {
        allow read, write: if isSignedIn();
      }
      match /pollVotes/{voteId} {
        allow read: if isSignedIn();
        allow write: if isUser(voteId); // Can only vote for yourself
      }
    }
    
    match /flashes/{flashId} {
      // Any signed-in user can read flashes.
      allow read, create: if isSignedIn();
      // Only the creator can delete their own flash.
      allow delete: if isUser(resource.data.userId);
    }
    
    // ---------------------------
    // App Status & Admin
    // ---------------------------
    match /app_status/{statusId} {
      allow read: if true;
      // Only admins can write to app status
      allow write: if isUserAdmin(request.auth.uid);
    }

    // ---------------------------
    // Calls & Signal
    // ---------------------------
    match /calls/{callId} {
      // Only participants of the call can read/write to the call document
      allow read, write, delete: if isUser(resource.data.callerId) || isUser(resource.data.calleeId);

      match /offerCandidates/{candidateId} {
        allow write: if isUser(get(/databases/$(database)/documents/calls/$(callId)).data.callerId);
      }
      match /answerCandidates/{candidateId} {
        allow write: if isUser(get(/databases/$(database)/documents/calls/$(callId)).data.calleeId);
      }
    }
    
    match /chats/{chatId}/messages/{messageId} {
    	// Allow read/write if the user is a member of the group (for group chats)
      // or if the chatId contains the user's ID (for 1-on-1 chats)
    	allow read, write: if isSignedIn() && (
      	 (exists(/databases/$(database)/documents/groups/$(chatId)) && isGroupMember(chatId)) ||
         (!exists(/databases/$(database)/documents/groups/$(chatId)) && request.auth.uid in chatId.split('_'))
      );
      allow delete: if isUser(resource.data.sender); // Allow deleting own messages
    }
    
    match /groups/{groupId} {
    	allow read: if isGroupMember(groupId);
      allow create: if isSignedIn();
      allow update: if isGroupAdmin(groupId);
      allow delete: if isUser(get(/databases/$(database)/documents/groups/$(groupId)).data.createdBy); // Only original creator can delete
    }

    // ---------------------------
    // Store & Community Content
    // ---------------------------
    match /products/{productId} {
      // Anyone can see the products
      allow read: if true;
      // Only admins can add/update/delete products
      allow write: if isUserAdmin(request.auth.uid);
    }
    
    match /songs/{songId} {
      allow read: if true;
      allow create: if isCreator() || isUserAdmin(request.auth.uid);
      allow update, delete: if isUser(resource.data.userId) || isUserAdmin(request.auth.uid);
    }

    match /playlists/{playlistId} {
      allow read, write, delete: if isUser(resource.data.ownerId);
    }
    
    match /collections/{collectionId} {
      allow read, write, delete: if isUser(resource.data.ownerId);
    }
    
     match /games/{gameId} {
      allow read: if true;
      allow create: if isUserAdmin(request.auth.uid); // Only admins can add new games
      allow write: if isUserAdmin(request.auth.uid);
    }
    
    // ---------------------------
    // Ad Campaign Data
    // ---------------------------
    match /adCampaigns/{campaignId} {
      allow read: if true; // Ads are public
      allow create: if isSignedIn(); // Any signed-in business user can create
      allow update: if isUser(resource.data.advertiserId);
      
      match /creatives/{creativeId} {
        allow read: if true;
        allow create: if isSignedIn();
      }
    }

  }
}
